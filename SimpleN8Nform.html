<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple N8N Form</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            color: #333;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 700px;
            margin: 20px auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 20px;
        }
        form {
            display: flex;
            flex-direction: column;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="text"],
        input[type="email"],
        input[type="tel"],
        select,
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 16px;
        }
        textarea {
            min-height: 80px;
            resize: vertical;
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            justify-content: center; /* Center horizontally */
            margin-top: 32px; /* More space above */
            margin-bottom: 32px; /* More space below */
        }
        .checkbox-group input[type="checkbox"] {
            margin-right: 12px;
            width: 22px;
            height: 22px;
        }
        .checkbox-group label {
            margin-bottom: 0;
            font-weight: normal;
            font-size: 1.08em;
        }
        button[type="submit"] {
            background-color: #5cb85c;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
            margin-top: 10px;
        }
        button[type="submit"]:hover {
            background-color: #4cae4c;
        }
        .hidden-field {
            display: none;
        }
        /* Basic responsive two-column layout for larger screens */
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px; /* Space between columns */
        }
        .form-row .form-group {
            flex: 1; /* Each group takes equal space */
            min-width: calc(50% - 10px); /* Adjust for gap, ensuring two columns */
        }

        /* Styles for the shipping rates section */
        #shippingRatesContainer {
            margin-top: 30px;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 8px;
            border: 1px solid #eee;
        }
        .rate-option {
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background-color: #fff;
            cursor: pointer;
            transition: background-color 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
            position: relative; /* For hidden radio if needed, and general structure */
        }
        .rate-option:hover {
            background-color: #e9f5ff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .rate-option.selected-rate {
            background-color: #d4edda; /* Light green for selection */
            border-color: #b1dfbb; /* Matching border color */
            box-shadow: 0 2px 5px rgba(0,0,0,0.15); /* Slightly enhanced shadow for selected */
        }
        .rate-option input[type="radio"] {
            position: absolute; /* Visually hide the radio button */
            opacity: 0;
            width: 1px;
            height: 1px;
            margin: -1px;
            overflow: hidden;
            clip: rect(0,0,0,0);
            border: 0;
            pointer-events: none;
        }
        /* Remove specific label styling that's no longer needed for this structure */
        /* .rate-option label { ... } */

        .rate-details {
            margin-left: 0; /* Was 25px, reset for new layout */
            font-size: 0.85em; /* Make details text slightly smaller */
            color: #666; /* Slightly lighter color for details */
            margin-top: 8px; /* Space between first line and details line */
            line-height: 1.4; /* Adjust for readability if it wraps */
            word-break: break-word; /* Ensure long strings of details wrap */
        }
        /* Remove .rate-details p styling as it will be a single text node */
        /* .rate-details p { ... } */

        .rate-carrier {
            font-weight: bold;
            font-size: 1.1em;
            color: #333;
        }
        .rate-price {
            font-weight: bold;
            color: #28a745; /* Green for price */
            font-size: 1.1em;
        }

        /* Styles for Product Order Section */
        #productOrderContainer {
            margin-top: 20px;
            padding: 15px;
            background-color: #fdfdfd;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
        }

        .product-order-line { /* New: For single line layout */
            display: flex;
            align-items: center;
            gap: 15px; /* Gap between label, controls, and price block */
        }

        .product-order-line > label[for="smartDucksQuantity"] { /* "Number of SmartDucks:" label */
            margin-bottom: 0; /* Override default label margin */
            font-weight: bold; /* Make the label bold */
        }

        .product-order-controls {
            display: flex;
            align-items: center;
            gap: 10px; /* Gap between -, quantity, + */
            margin-top: 0; /* Was 10px, remove as it's inline now */
        }
        .product-order-controls button {
            padding: 8px 12px;
            font-size: 1em;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .product-order-controls button:hover {
            background-color: #0056b3;
        }
        .product-order-controls button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .product-price-display { /* New: Wrapper for price label and value */
            display: flex;
            align-items: center;
            gap: 5px; /* Space between "Total Price:" and the value */
            margin-left: auto; /* Pushes this to the far right */
        }

        #quantityDisplay, #totalPriceDisplay {
            font-size: 1.1em;
            font-weight: bold;
        }
        #totalPriceDisplay {
            color: #28a745; /* Green for price, consistent with shipping */
        }
        .price-label { /* "Total Price:" label specific styling */
            font-size: 0.9em;
            color: #555;
            margin-bottom: 0; /* Override default label margin */
            font-weight: normal; /* Override default label bold */
        }


        @media (max-width: 600px) {
            .form-row .form-group {
                min-width: 100%; /* Full width on smaller screens */
            }
        }
    </style>
</head>
<body>
    <div style="text-align: center; padding: 5px; background-color: #f0f0f0; font-size: 0.9em;">
        <p>Form Version: 1.0.80 - 2025-06-04</p>
    </div>
    <div class="container">
        <h1>SmartDucks Order and Shipping</h1>

        <!-- Debug/Error area -->
        <div id="formDebug" style="display:none; background:#fee; color:#900; padding:10px; margin-bottom:15px; border:1px solid #c00; border-radius:4px; font-size:1em;"></div>

        <form action="https://duckpond.smartducks.works/webhook/shiptime-rates2" method="POST">
            <!-- Hidden fields -->
            <input type="hidden" name="_csrf" id="_csrf" value="dummyCSRFToken12345">
            <div class="hidden-field">
                <label for="website">Website (Honeypot)</label>
                <input type="text" name="website" id="website">
            </div>

            <fieldset>
                <legend>Recipient Information</legend>
                <div class="form-row">
                    <div class="form-group">
                        <label for="firstName">First Name</label>
                        <input type="text" id="firstName" name="firstName" required>
                    </div>
                    <div class="form-group">
                        <label for="lastName">Last Name</label>
                        <input type="text" id="lastName" name="lastName" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" name="email" required>
                    </div>
                    <div class="form-group">
                        <label for="phone">Phone</label>
                        <input type="tel" id="phone" name="phone" required placeholder="e.g., +1 (555) 123-4567">
                    </div>
                </div>
                <div class="form-group">
                    <label for="companyName">Company Name (Optional)</label>
                    <input type="text" id="companyName" name="companyName">
                </div>
            </fieldset>

            <fieldset>
                <legend>Shipping Address</legend>
                <div class="form-row">
                    <div class="form-group">
                        <label for="countryCode">Country</label>
                        <select id="countryCode" name="countryCode" required>
                            <option value="">-- Select Country --</option>
                            <option value="CA">Canada</option>
                            <option value="US">United States</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="state">State/Province</label>
                        <select id="state" name="state" required>
                            <option value="">-- Select State/Province --</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="city">City</label>
                        <input type="text" id="city" name="city" required>
                    </div>
                    <div class="form-group">
                        <label for="postalCode">Postal/Zip Code</label>
                        <input type="text" id="postalCode" name="postalCode" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="streetAddress">Street Address</label>
                    <input type="text" id="streetAddress" name="streetAddress" required>
                </div>
                <div class="form-group">
                    <label for="streetAddress2">Apartment, suite, etc. (Optional)</label>
                    <input type="text" id="streetAddress2" name="streetAddress2">
                </div>
                 <div class="form-group checkbox-group">
                    <input type="checkbox" id="residential" name="residential">
                    <label for="residential">This is a business address.</label>
                </div>
                <div class="form-group">
                    <div style="font-weight: bold; margin-bottom: 4px;">Veriy Important Information pertaining to 2.4 GHz connection to your router.</div>
                    <div style="font-size: 0.95em; color: #555; margin-bottom: 8px;">Required to write directly to your SmartDucks but not stored. You can refuse, just alot more work at install time.</div>
                    <div style="display: flex; gap: 15px; align-items: flex-start;">
                        <div style="flex: 1; min-width: 0; display: flex; flex-direction: column;">
                            <label for="wifiSsid">SSID:</label>
                            <input type="text" id="wifiSsid" name="wifiSsid" autocomplete="off" style="width: 100%; min-height: 42px; line-height: 1.2; box-sizing: border-box; padding: 10px;">
                        </div>
                        <div style="flex: 1; min-width: 0; display: flex; flex-direction: column;">
                            <label for="wifiPassword">Password:</label>
                            <input type="password" id="wifiPassword" name="wifiPassword" autocomplete="off" style="width: 100%; min-height: 42px; line-height: 1.2; box-sizing: border-box; padding: 10px;">
                        </div>
                    </div>
                </div>
            </fieldset>

            <!-- Product Order Section -->
            <fieldset id="productOrderContainer">
                <legend>Your SmartDucks Order</legend>
                <div class="form-group product-order-line">
                    <label for="smartDucksQuantity">Number of SmartDucks:</label>
                    <div class="product-order-controls">
                        <button type="button" id="decreaseQuantity">-</button>
                        <span id="quantityDisplay">5</span>
                        <button type="button" id="increaseQuantity">+</button>
                    </div>
                </div>
                <div id="pricingBreakdown" style="margin-top:10px;"></div>
                <div class="product-price-display" style="margin-top:10px;">
                    <label class="price-label">Total Price:</label>
                    <div>$<span id="totalPriceDisplay">520.00</span></div>
                </div>
            </fieldset>
            <!-- End Product Order Section -->

            <fieldset>
                <legend>Other Information</legend>
                <div class="form-group">
                    <label for="instructions">Special Instructions (Optional)</label>
                    <textarea id="instructions" name="instructions"></textarea>
                </div>
            </fieldset>
            
            <button type="submit">Get Shipping Rates</button>
        </form>

        <!-- New section for displaying shipping rates -->
        <div id="shippingRatesContainer" style="display: none;">
            <h2>Available Shipping Rates</h2>
            <div id="ratesList">
                <!-- Rates will be populated here by JavaScript -->
            </div>
            <button id="confirmShippingRate" style="display: none; margin-top: 15px; background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer;">Confirm Selection</button>
        </div>

        <!-- Stripe Elements Card UI (hidden by default) -->
        <div id="stripePaymentSection" style="display:none; margin-top:30px;">
            <h2>Enter Payment Details</h2>
            <!-- Express Checkout Element (Apple Pay/Google Pay/Link) -->
            <div id="express-checkout-element" style="margin-bottom:20px;"></div>
            <div id="express-errors" style="color:#c00;margin-bottom:10px;"></div>
            <div class="form-row">
                <div class="form-group" style="flex:1; min-width:180px;">
                    <label for="billingName">Billing Name</label>
                    <input type="text" id="billingName" name="billingName" autocomplete="name" required>
                </div>
                <div class="form-group" style="flex:1; min-width:180px;">
                    <label for="billingEmail">Billing Email</label>
                    <input type="email" id="billingEmail" name="billingEmail" autocomplete="email" required>
                </div>
            </div>
            <div id="card-element" style="margin-bottom:15px;"></div>
            <button id="payNowButton" style="background-color:#28a745;color:white;padding:10px 20px;border:none;border-radius:4px;cursor:pointer;">Pay Now</button>
            <div id="card-errors" style="color:#c00;margin-top:10px;"></div>
        </div>
    </div>

    <script src="https://js.stripe.com/v3/"></script>
    <script>
    // Show a message if JS is running
    console.log('SmartDucks form JS loaded, version 1.0.53');
    const formDebug = document.getElementById('formDebug');
    function showDebug(msg, errObj) {
        if (formDebug) {
            formDebug.style.display = 'block';
            formDebug.textContent = msg;
        }
        if (errObj) {
            console.error(msg, errObj);
        } else {
            console.error(msg);
        }
    }
    function clearDebug() {
        if (formDebug) {
            formDebug.style.display = 'none';
            formDebug.textContent = '';
        }
    }
    window.onerror = function(message, source, lineno, colno, error) {
        showDebug('JS Error: ' + message + ' at ' + source + ':' + lineno);
        return false;
    };

document.addEventListener('DOMContentLoaded', function () {
    clearDebug();
    // --- DOM references ---
    const form = document.querySelector('form');
    const phoneInput = document.getElementById('phone');
    const countryInput = document.getElementById('countryCode');
    const stateInput = document.getElementById('state');
    const postalCodeInput = document.getElementById('postalCode');
    const quantityDisplay = document.getElementById('quantityDisplay');
    const totalPriceDisplay = document.getElementById('totalPriceDisplay');
    const decreaseQuantityBtn = document.getElementById('decreaseQuantity');
    const increaseQuantityBtn = document.getElementById('increaseQuantity');
    const shippingRatesContainer = document.getElementById('shippingRatesContainer');
    const ratesList = document.getElementById('ratesList');
    const confirmShippingRateBtn = document.getElementById('confirmShippingRate');
    const pricingBreakdownDiv = document.getElementById('pricingBreakdown');

    // --- Constants ---
    const PRODUCT_UNIT_PRICE = 70.00;
    const MIN_QUANTITY = 5;
    const MAX_QUANTITY = 20; // Changed from 100 to 20
    let currentQuantity = MIN_QUANTITY;
    let selectedRate = null;
    let shippingRates = [];
    let paymentIntentClientSecret = null;
    let hasAttemptedRates = false; // New flag to track if user has attempted to get rates

    // --- CSRF Token Generation (for dev/testing) ---
    function generateRandomCSRFToken() {
        // 32-char hex string
        return Array.from(crypto.getRandomValues(new Uint8Array(16))).map(b => b.toString(16).padStart(2, '0')).join('');
    }
    const csrfInput = document.getElementById('_csrf');
    if (csrfInput && (!csrfInput.value || csrfInput.value === 'dummyCSRFToken12345')) {
        csrfInput.value = generateRandomCSRFToken();
    }

    // --- State/Province Dropdown Logic ---
    const statesProvinces = {
        CA: [
            { value: 'AB', name: 'Alberta' }, { value: 'BC', name: 'British Columbia' }, { value: 'MB', name: 'Manitoba' },
            { value: 'NB', name: 'New Brunswick' }, { value: 'NL', name: 'Newfoundland and Labrador' }, { value: 'NS', name: 'Nova Scotia' },
            { value: 'NT', name: 'Northwest Territories' }, { value: 'NU', name: 'Nunavut' }, { value: 'ON', name: 'Ontario' },
            { value: 'PE', name: 'Prince Edward Island' }, { value: 'QC', name: 'Quebec' }, { value: 'SK', name: 'Saskatchewan' },
            { value: 'YT', name: 'Yukon' }
        ],
        US: [
            { value: 'AL', name: 'Alabama' }, { value: 'AK', name: 'Alaska' }, { value: 'AZ', name: 'Arizona' },
            { value: 'AR', name: 'Arkansas' }, { value: 'CA', name: 'California' }, { value: 'CO', name: 'Colorado' },
            { value: 'CT', name: 'Connecticut' }, { value: 'DE', name: 'Delaware' }, { value: 'FL', name: 'Florida' },
            { value: 'GA', name: 'Georgia' }, { value: 'HI', name: 'Hawaii' }, { value: 'ID', name: 'Idaho' },
            { value: 'IL', name: 'Illinois' }, { value: 'IN', name: 'Indiana' }, { value: 'IA', name: 'Iowa' },
            { value: 'KS', name: 'Kansas' }, { value: 'KY', name: 'Kentucky' }, { value: 'LA', name: 'Louisiana' },
            { value: 'ME', name: 'Maine' }, { value: 'MD', name: 'Maryland' }, { value: 'MA', name: 'Massachusetts' },
            { value: 'MI', name: 'Michigan' }, { value: 'MN', name: 'Minnesota' }, { value: 'MS', name: 'Mississippi' },
            { value: 'MO', name: 'Missouri' }, { value: 'MT', name: 'Montana' }, { value: 'NE', name: 'Nebraska' },
            { value: 'NV', name: 'Nevada' }, { value: 'NH', name: 'New Hampshire' }, { value: 'NJ', name: 'New Jersey' },
            { value: 'NM', name: 'New Mexico' }, { value: 'NY', name: 'New York' }, { value: 'NC', name: 'North Carolina' },
            { value: 'ND', name: 'North Dakota' }, { value: 'OH', name: 'Ohio' }, { value: 'OK', name: 'Oklahoma' },
            { value: 'OR', name: 'Oregon' }, { value: 'PA', name: 'Pennsylvania' }, { value: 'RI', name: 'Rhode Island' },
            { value: 'SC', name: 'South Carolina' }, { value: 'SD', name: 'South Dakota' }, { value: 'TN', name: 'Tennessee' },
            { value: 'TX', name: 'Texas' }, { value: 'UT', name: 'Utah' }, { value: 'VT', name: 'Vermont' },
            { value: 'VA', name: 'Virginia' }, { value: 'WA', name: 'Washington' }, { value: 'WV', name: 'West Virginia' },
            { value: 'WI', name: 'Wisconsin' }, { value: 'WY', name: 'Wyoming' }
        ]
    };
    function updateStatesProvinces(forceValue) {
        try {
            if (!countryInput || !stateInput) {
                console.error('State/Province dropdown: countryInput or stateInput not found');
                return;
            }
            const selectedCountry = countryInput.value;
            const prevValue = forceValue !== undefined ? forceValue : stateInput.value;
            stateInput.innerHTML = '<option value="">-- Select State/Province --</option>';
            if (selectedCountry && statesProvinces[selectedCountry]) {
                statesProvinces[selectedCountry].forEach(function (sp) {
                    const option = document.createElement('option');
                    option.value = sp.value;
                    option.textContent = sp.name;
                    stateInput.appendChild(option);
                });
                // Restore previous value if still valid
                if (prevValue && statesProvinces[selectedCountry].some(sp => sp.value === prevValue)) {
                    stateInput.value = prevValue;
                } else {
                    stateInput.value = '';
                }
            } else {
                stateInput.value = '';
            }
        } catch (err) {
            console.error('State/Province dropdown error:', err);
            // Fallback: ensure at least the default option is present
            if (stateInput) stateInput.innerHTML = '<option value="">-- Select State/Province --</option>';
        }
    }
    countryInput.addEventListener('change', updateStatesProvinces);
    countryInput.addEventListener('input', updateStatesProvinces);
    form.addEventListener('reset', function() { setTimeout(updateStatesProvinces, 0); });
    updateStatesProvinces();

    // --- Phone and Postal/Zip Formatting ---
    function formatPhoneNumber(value) {
        let phoneNumber = value.replace(/\D/g, '');
        if (phoneNumber.length === 10) {
            return `(${phoneNumber.substring(0, 3)}) ${phoneNumber.substring(3, 6)}-${phoneNumber.substring(6)}`;
        } else if (phoneNumber.length === 11 && phoneNumber.startsWith('1')) {
            phoneNumber = phoneNumber.substring(1);
            return `(${phoneNumber.substring(0, 3)}) ${phoneNumber.substring(3, 6)}-${phoneNumber.substring(6)}`;
        }
        // If not 10 or 11 digits, return as-is (do not format)
        return value;
    }
    function phoneFormatHandler() {
        // Only format if 10 or 11 digits, else leave as-is
        const raw = phoneInput.value.replace(/\D/g, '');
        if (raw.length === 10 || (raw.length === 11 && raw.startsWith('1'))) {
            phoneInput.value = formatPhoneNumber(phoneInput.value);
        } else {
            // If not enough digits, do not format or change the value
            phoneInput.value = raw;
        }
    }
    phoneInput.addEventListener('blur', phoneFormatHandler);
    // Remove input event formatting to avoid interfering with user typing

    // When a shipping rate is selected, do not reformat the phone number
    // (No code needed here unless you have a handler that modifies phoneInput.value)

    function postalFormatHandler() {
        const selectedCountry = countryInput.value;
        let postalCode = postalCodeInput.value.trim();
        if (selectedCountry === 'CA' && postalCode) {
            let cleaned = postalCode.toUpperCase().replace(/[^A-Z0-9]/g, '');
            if (cleaned.length > 6) cleaned = cleaned.substring(0, 6);
            if (cleaned.length === 6) {
                postalCodeInput.value = cleaned.substring(0, 3) + ' ' + cleaned.substring(3);
            } else {
                postalCodeInput.value = cleaned;
            }
        } else if (selectedCountry === 'US' && postalCode) {
            let cleaned = postalCode.replace(/[^0-9]/g, '');
            if (cleaned.length === 9) {
                postalCodeInput.value = cleaned.substring(0,5) + '-' + cleaned.substring(5);
            } else if (cleaned.length === 5) {
                postalCodeInput.value = cleaned;
            } else {
                postalCodeInput.value = cleaned;
            }
        }
    }
    postalCodeInput.addEventListener('blur', postalFormatHandler);
    postalCodeInput.addEventListener('input', postalFormatHandler);

    // --- Product Quantity and Price Logic ---
    let lastQuantity = currentQuantity;
    function getUnitPriceForQuantity(qty) {
        if (qty <= 10) return 35;
        if (qty <= 15) return 40;
        return 45;
    }
    // Remove unused calculateOrderBreakdown and renderOrderBreakdown
    // Only use getPricingBreakdown and updatePricingBreakdown
    function getPricingBreakdown(qty) {
        let lines = [];
        let total = 0;
        // Base 5 SmartDucks
        lines.push(`<div>5 SmartDucks (Base): $400</div>`);
        total += 400;
        // 6-9: $35 each
        if (qty > 5) {
            const n = Math.min(qty, 9) - 5;
            if (n > 0) {
                lines.push(`<div>${n} × $35 = $${(n*35).toFixed(2)}</div>`);
                total += n * 35;
            }
        }
        // 10-14: $40 each
        if (qty > 9) {
            const n = Math.min(qty, 14) - 9;
            if (n > 0) {
                lines.push(`<div>${n} × $40 = $${(n*40).toFixed(2)}</div>`);
                total += n * 40;
            }
        }
        // 15-20: $45 each
        if (qty > 14) {
            const n = Math.min(qty, 20) - 14;
            if (n > 0) {
                lines.push(`<div>${n} × $45 = $${(n*45).toFixed(2)}</div>`);
                total += n * 45;
            }
        }
        // DuckFeed (annual)
        lines.push(`<div>DuckFeed (annual): $120</div>`);
        total += 120;
        return { lines, total };
    }
    function updatePricingBreakdown() {
        const qty = currentQuantity;
        const breakdown = getPricingBreakdown(qty);
        pricingBreakdownDiv.innerHTML = breakdown.lines.join('');
        totalPriceDisplay.textContent = breakdown.total.toFixed(2);
    }
    // Update on quantity change
    function updateQuantityDisplay() {
        quantityDisplay.textContent = currentQuantity;
        decreaseQuantityBtn.disabled = currentQuantity <= MIN_QUANTITY;
        increaseQuantityBtn.disabled = currentQuantity >= MAX_QUANTITY;
        updatePricingBreakdown();
    }
    decreaseQuantityBtn.addEventListener('click', function () {
        if (currentQuantity > MIN_QUANTITY) {
            currentQuantity--;
            updateQuantityDisplay();
            // Clear/hide shipping rates and reset selection
            shippingRatesContainer.style.display = 'none';
            ratesList.innerHTML = '';
            confirmShippingRateBtn.style.display = 'none';
            selectedRate = null;
            shippingRates = [];
            paymentIntentClientSecret = null;
        }
    });
    increaseQuantityBtn.addEventListener('click', function () {
        if (currentQuantity < MAX_QUANTITY) {
            currentQuantity++;
            updateQuantityDisplay();
            // Clear/hide shipping rates and reset selection
            shippingRatesContainer.style.display = 'none';
            ratesList.innerHTML = '';
            confirmShippingRateBtn.style.display = 'none';
            selectedRate = null;
            shippingRates = [];
            paymentIntentClientSecret = null;
        }
    });
    // Initial button state
    updateQuantityDisplay();
    lastQuantity = currentQuantity;

    // --- Shipping Rates AJAX Logic ---
    function collectFormData() {
        // Build the nested 'from' and 'to' objects as expected by the server
        const firstName = document.getElementById('firstName').value.trim();
        const lastName = document.getElementById('lastName').value.trim();
        const companyName = document.getElementById('companyName').value.trim();
        const attention = (firstName + ' ' + lastName).trim();
        return {
            from: {
                companyName: "SmartDucks.Works",
                streetAddress: "2053 Wildflower Drive",
                city: "Orleans",
                state: "ON",
                postalCode: "K1E 3R5",
                countryCode: "CA",
                attention: "SmartDucks Support",
                phone: "6137993682",
                email: "support@smartducks.works"
            },
            to: {
                companyName: companyName || attention,
                streetAddress: document.getElementById('streetAddress').value.trim(),
                city: document.getElementById('city').value.trim(),
                state: document.getElementById('state').value.trim(),
                postalCode: document.getElementById('postalCode').value.trim(),
                countryCode: document.getElementById('countryCode').value.trim(),
                attention: attention,
                phone: document.getElementById('phone').value.trim(),
                email: document.getElementById('email').value.trim()
            },
            residential: document.getElementById('residential').checked,
            quantity: currentQuantity
        };
    }
    function validateShippingFields() {
        // Basic validation for required fields
        const data = collectFormData();
        // Check for non-empty fields
        if (!data.to.countryCode || !data.to.state || !data.to.city || !data.to.postalCode || !data.to.streetAddress) return false;
        if (data.quantity < MIN_QUANTITY || data.quantity > MAX_QUANTITY) return false;
        // Validate state/province
        if (!statesProvinces[data.to.countryCode] || !statesProvinces[data.to.countryCode].some(sp => sp.value === data.to.state)) return false;
        // Validate phone (North American 10-digit)
        const phoneDigits = phoneInput.value.replace(/\D/g, '');
        if (phoneDigits.length !== 10) return false;
        // Validate postal/zip code
        if (data.to.countryCode === 'CA') {
            // Canadian postal code: A1A 1A1
            if (!/^([A-VXY][0-9][A-Z]) ?([0-9][A-Z][0-9])$/i.test(data.to.postalCode.replace(/\s/g, ''))) return false;
        } else if (data.to.countryCode === 'US') {
            // US ZIP: 12345 or 12345-6789
            if (!/^\d{5}(-\d{4})?$/.test(data.to.postalCode)) return false;
        }
        return true;
    }
    function fetchShippingRates() {
        try {
            if (!validateShippingFields()) {
                shippingRatesContainer.style.display = 'none';
                showDebug('Validation failed: Please check all required fields.');
                return;
            }
            const data = collectFormData();
            ratesList.innerHTML = '<div>Loading shipping rates...</div>';
            shippingRatesContainer.style.display = 'block';
            fetch('https://duckpond.smartducks.works/webhook/shiptime-rates2', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ data })
            })
            .then(res => res.json())
            .then(json => {
                if (!json.rates || !Array.isArray(json.rates) || json.rates.length === 0) {
                    ratesList.innerHTML = '<div>No shipping rates found for this address/quantity.</div>';
                    confirmShippingRateBtn.style.display = 'none';
                    showDebug('No shipping rates found for this address/quantity.');
                    return;
                }
                shippingRates = json.rates;
                try {
                    renderShippingRates();
                } catch (err) {
                    showDebug('Error rendering shipping rates: ' + err.message, err);
                    shippingRatesContainer.style.display = 'none';
                }
            })
            .catch((err) => {
                showDebug('Error fetching shipping rates: ' + (err && err.message ? err.message : err), err);
                ratesList.innerHTML = '<div>Error fetching shipping rates. Please check your address and try again.</div>';
                confirmShippingRateBtn.style.display = 'none';
            });
        } catch (err) {
            showDebug('Unexpected error in fetchShippingRates: ' + err.message, err);
            shippingRatesContainer.style.display = 'none';
        }
    }
    function renderShippingRates() {
        try {
            ratesList.innerHTML = '';
            shippingRates.forEach((rate, idx) => {
                const div = document.createElement('div');
                div.className = 'rate-option';
                div.tabIndex = 0;
                div.innerHTML = `
                    <input type="radio" name="shippingRate" id="rate${idx}" value="${idx}" ${selectedRate === idx ? 'checked' : ''} />
                    <span class="rate-carrier">${rate.carrier}</span> - <span class="rate-price">$${rate.cost.toFixed(2)}</span>
                    <div class="rate-details">${rate.service} &bull; Est: ${rate.delivery_days ? rate.delivery_days + ' days' : (rate.estimatedDelivery || 'N/A')}</div>
                `;
                div.addEventListener('click', function () {
                    selectShippingRate(idx);
                });
                div.addEventListener('keydown', function (e) {
                    if (e.key === 'Enter' || e.key === ' ') selectShippingRate(idx);
                });
                if (selectedRate === idx) div.classList.add('selected-rate');
                ratesList.appendChild(div);
            });
            confirmShippingRateBtn.style.display = 'block';
        } catch (err) {
            showDebug('Error in renderShippingRates: ' + err.message, err);
            shippingRatesContainer.style.display = 'none';
        }
    }

    // --- Shipping Rate Selection Handler ---
    function selectShippingRate(idx) {
        try {
            if (typeof idx !== 'number' || !shippingRates[idx]) {
                showDebug('Invalid shipping rate selection.');
                return;
            }
            selectedRate = idx;
            // Update UI: highlight selected, update radio
            Array.from(ratesList.children).forEach((div, i) => {
                if (i === idx) {
                    div.classList.add('selected-rate');
                    const radio = div.querySelector('input[type="radio"]');
                    if (radio) radio.checked = true;
                } else {
                    div.classList.remove('selected-rate');
                    const radio = div.querySelector('input[type="radio"]');
                    if (radio) radio.checked = false;
                }
            });
            confirmShippingRateBtn.style.display = 'block';
            confirmShippingRateBtn.disabled = false;
            clearDebug();
        } catch (err) {
            showDebug('Error selecting shipping rate: ' + err.message, err);
        }
    }

    // --- Payment Intent (Stripe) Logic ---
    // Add feedback elements
    let paymentStatusDiv = document.getElementById('paymentStatusDiv');
    if (!paymentStatusDiv) {
        paymentStatusDiv = document.createElement('div');
        paymentStatusDiv.id = 'paymentStatusDiv';
        paymentStatusDiv.style = 'margin-top:20px; color:#007bff; font-weight:bold;';
        shippingRatesContainer.appendChild(paymentStatusDiv);
    }
    function setPaymentStatus(msg, isError) {
        paymentStatusDiv.textContent = msg;
        paymentStatusDiv.style.color = isError ? '#c00' : '#007bff';
    }
    function clearPaymentStatus() {
        paymentStatusDiv.textContent = '';
    }
    function buildCustomerPayload() {
        // Build nested address object for Stripe
        return {
            firstName: document.getElementById('firstName').value.trim(),
            lastName: document.getElementById('lastName').value.trim(),
            email: document.getElementById('email').value.trim(),
            phone: phoneInput.value.trim(),
            companyName: document.getElementById('companyName').value.trim(),
            address: {
                line1: document.getElementById('streetAddress').value.trim(),
                line2: document.getElementById('streetAddress2').value.trim(),
                city: document.getElementById('city').value.trim(),
                state: stateInput.value.trim(),
                postal_code: postalCodeInput.value.trim(),
                country: countryInput.value.trim()
            }
        };
    }
    function buildPaymentIntentPayload(customerId, orderDetails) {
        // Use the same breakdown as the UI
        // 'instructions' will be sent to Stripe as metadata (see N8N workflow)
        const breakdown = getPricingBreakdown(orderDetails.quantity);
        const totalPrice = breakdown.total;
        // Always send all metadata fields as non-null strings
        const metadata = {
            instructions: (typeof orderDetails.instructions === 'string') ? orderDetails.instructions : '',
            // Add future metadata fields here, always as strings
            idempotencyKey: orderDetails.idempotencyKey || ''
        };
        // Debug: log outgoing payment intent payload for admin verification
        if (window && window.localStorage) {
            try {
                window.localStorage.setItem('lastPaymentIntentPayload', JSON.stringify({
                    customerId,
                    quantity: orderDetails.quantity,
                    totalPrice,
                    shippingRate: orderDetails.shippingRate,
                    address: orderDetails.address,
                    email: orderDetails.email,
                    phone: orderDetails.phone,
                    metadata,
                    idempotencyKey: orderDetails.idempotencyKey,
                    _csrf: document.getElementById('_csrf').value
                }, null, 2));
            } catch (e) { /* ignore */ }
        }
        return {
            customerId: customerId,
            customer: customerId, // Add for N8N compatibility
            quantity: orderDetails.quantity,
            unitPrice: getUnitPriceForQuantity(orderDetails.quantity),
            totalPrice: totalPrice,
            amount: Math.round(totalPrice * 100), // Stripe expects amount in cents
            shippingRate: orderDetails.shippingRate,
            address: orderDetails.address,
            email: orderDetails.email,
            phone: orderDetails.phone,
            // Always send metadata as an object
            metadata,
            idempotencyKey: orderDetails.idempotencyKey, // New: Add idempotency key
            _csrf: document.getElementById('_csrf').value
        };
    }
    let paymentIntentInProgress = false; // Prevent double payment intent
    function startStripePayment() {
        if (paymentIntentInProgress) {
            showDebug('Payment is already being processed. Please wait.');
            return;
        }
        paymentIntentInProgress = true;
        // Gather all form data for payment
        const orderDetails = {
            firstName: document.getElementById('firstName').value.trim(),
            lastName: document.getElementById('lastName').value.trim(),
            email: document.getElementById('email').value.trim(),
            phone: phoneInput.value.trim(),
            companyName: document.getElementById('companyName').value.trim(),
            countryCode: countryInput.value.trim(),
            state: stateInput.value.trim(),
            city: document.getElementById('city').value.trim(),
            postalCode: postalCodeInput.value.trim(),
            streetAddress: document.getElementById('streetAddress').value.trim(),
            streetAddress2: document.getElementById('streetAddress2').value.trim(),
            residential: document.getElementById('residential').checked,
            quantity: currentQuantity,
            shippingRate: shippingRates[selectedRate],
            instructions: document.getElementById('instructions').value.trim(),
            address: {
                line1: document.getElementById('streetAddress').value.trim(),
                line2: document.getElementById('streetAddress2').value.trim(),
                city: document.getElementById('city').value.trim(),
                state: stateInput.value.trim(),
                postal_code: postalCodeInput.value.trim(),
                country: countryInput.value.trim()
            }
        };
        const orderSessionKey = getOrderSessionKey(orderDetails);
        let persisted = getPersistedOrderData(orderSessionKey);
        let idempotencyKey, customerId;
        if (persisted && persisted.customerId && persisted.idempotencyKey) {
            // Reuse existing for this order
            idempotencyKey = persisted.idempotencyKey;
            customerId = persisted.customerId;
        } else {
            // New order/session
            idempotencyKey = (window.crypto && window.crypto.randomUUID) ? window.crypto.randomUUID() : (Date.now() + '-' + Math.random().toString(36).substr(2, 9));
        }
        confirmShippingRateBtn.disabled = true;
        setPaymentStatus('Creating customer...', false);
        const customerPayload = buildCustomerPayload();
        customerPayload.idempotencyKey = idempotencyKey;
        if (customerId) {
            // If we already have a customerId, skip customer creation and go straight to payment intent
            setPaymentStatus('Customer found. Creating payment intent...', false);
            const paymentIntentPayload = buildPaymentIntentPayload(customerId, orderDetails);
            paymentIntentPayload.idempotencyKey = idempotencyKey;
            fetch('https://duckpond.smartducks.works/webhook/payment-intent', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': document.getElementById('_csrf').value
                },
                body: JSON.stringify({ data: paymentIntentPayload })
            })
            .then(res2 => res2.json())
            .then(json2 => {
                const clientSecret = json2.clientSecret || json2.client_secret;
                if (!clientSecret) {
                    // Show full backend response for debugging
                    setPaymentStatus('Error creating payment intent: ' + (json2.message || 'Unknown error') + (json2.error ? ' (' + json2.error + ')' : '') + (json2.status ? ' [status: ' + json2.status + ']' : '') + (json2.statusCode ? ' [code: ' + json2.statusCode + ']' : '') + (json2.paymentIntentId ? ' [paymentIntentId: ' + json2.paymentIntentId + ']' : '') + (json2.paymentIntentStatus ? ' [paymentIntentStatus: ' + json2.paymentIntentStatus + ']' : '') + (json2.paymentIntentAmount ? ' [amount: ' + json2.paymentIntentAmount + ']' : '') + (json2.paymentIntentCurrency ? ' [currency: ' + json2.paymentIntentCurrency + ']' : '') + (json2.client_secret === undefined ? ' [client_secret missing in backend response]' : ''), true);
                    confirmShippingRateBtn.disabled = false;
                    paymentIntentInProgress = false;
                    // Also log the full response for admin debugging
                    if (window && window.localStorage) {
                        try { window.localStorage.setItem('lastPaymentIntentError', JSON.stringify(json2, null, 2)); } catch (e) {}
                    }
                    return;
                }
                // If message is 'Reusing existing PaymentIntent', treat as success
                if (json2.message && json2.message.toLowerCase().includes('reusing existing paymentintent')) {
                    setPaymentStatus('Payment intent found. Please enter your card details below.', false);
                } else {
                    setPaymentStatus('Payment intent created! Please enter your card details below.', false);
                }
                paymentIntentClientSecret = clientSecret;
                showStripeCardUI(paymentIntentClientSecret);
                confirmShippingRateBtn.disabled = false;
                paymentIntentInProgress = false;
            })
            .catch(err2 => {
                setPaymentStatus('Error creating payment intent. Please try again.', true);
                confirmShippingRateBtn.disabled = false;
                paymentIntentInProgress = false;
            });
            return;
        }
        // If no customerId, create customer as before
        fetch('https://duckpond.smartducks.works/webhook/create-customer', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                type: 'create_customer',
                data: customerPayload
            })
        })
        .then(res => res.json())
        .then(json => {
            if (!json.customerId) {
                setPaymentStatus('Error creating customer: ' + (json.message || 'Unknown error'), true);
                confirmShippingRateBtn.disabled = false;
                paymentIntentInProgress = false;
                return;
            }
            // Persist for this order/session
            persistOrderData(orderSessionKey, json.customerId, idempotencyKey);
            setPaymentStatus('Customer created. Creating payment intent...', false);
            const paymentIntentPayload = buildPaymentIntentPayload(json.customerId, orderDetails);
            paymentIntentPayload.idempotencyKey = idempotencyKey;
            fetch('https://duckpond.smartducks.works/webhook/payment-intent', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': document.getElementById('_csrf').value
                },
                body: JSON.stringify({ data: paymentIntentPayload })
            })
            .then(res2 => res2.json())
            .then(json2 => {
                const clientSecret = json2.clientSecret || json2.client_secret;
                if (!clientSecret) {
                    // Show full backend response for debugging
                    setPaymentStatus('Error creating payment intent: ' + (json2.message || 'Unknown error') + (json2.error ? ' (' + json2.error + ')' : '') + (json2.status ? ' [status: ' + json2.status + ']' : '') + (json2.statusCode ? ' [code: ' + json2.statusCode + ']' : '') + (json2.paymentIntentId ? ' [paymentIntentId: ' + json2.paymentIntentId + ']' : '') + (json2.paymentIntentStatus ? ' [paymentIntentStatus: ' + json2.paymentIntentStatus + ']' : '') + (json2.paymentIntentAmount ? ' [amount: ' + json2.paymentIntentAmount + ']' : '') + (json2.paymentIntentCurrency ? ' [currency: ' + json2.paymentIntentCurrency + ']' : '') + (json2.client_secret === undefined ? ' [client_secret missing in backend response]' : ''), true);
                    confirmShippingRateBtn.disabled = false;
                    paymentIntentInProgress = false;
                    // Also log the full response for admin debugging
                    if (window && window.localStorage) {
                        try { window.localStorage.setItem('lastPaymentIntentError', JSON.stringify(json2, null, 2)); } catch (e) {}
                    }
                    return;
                }
                // If message is 'Reusing existing PaymentIntent', treat as success
                if (json2.message && json2.message.toLowerCase().includes('reusing existing paymentintent')) {
                    setPaymentStatus('Payment intent found. Please enter your card details below.', false);
                } else {
                    setPaymentStatus('Payment intent created! Please enter your card details below.', false);
                }
                paymentIntentClientSecret = clientSecret;
                showStripeCardUI(paymentIntentClientSecret);
                confirmShippingRateBtn.disabled = false;
                paymentIntentInProgress = false;
            })
            .catch(err2 => {
                setPaymentStatus('Error creating payment intent. Please try again.', true);
                confirmShippingRateBtn.disabled = false;
                paymentIntentInProgress = false;
            });
        })
        .catch(err => {
            setPaymentStatus('Error creating customer. Please check your address and try again.', true);
            confirmShippingRateBtn.disabled = false;
            paymentIntentInProgress = false;
        });
    }

    // --- Confirm Shipping Rate Button Handler ---
    confirmShippingRateBtn.addEventListener('click', function () {
        if (selectedRate === null || shippingRates.length === 0) {
            alert('Please select a shipping rate before continuing.');
            return;
        }
        // Hide payment section before starting
        hideStripeCardUI();
        // Proceed to payment or next step
        startStripePayment();
    });

    // --- Stripe.js Integration ---
    let stripe = null;
    let elements = null;
    let cardElement = null;
    let expressElement = null;
    const stripePaymentSection = document.getElementById('stripePaymentSection');
    const cardErrorsDiv = document.getElementById('card-errors');
    const expressErrorsDiv = document.getElementById('express-errors');
    const payNowButton = document.getElementById('payNowButton');
    let latestClientSecret = null;
    const STRIPE_PUBLISHABLE_KEY = 'pk_live_51QL4n4G8FW8Uq8PBPZLJ0uhwZQ7vUEwmemkImC8MIkZsvNxVNUpfb9UEPAXd4ouyLUHWnh6Xbn0qC0XMWH7Kn1gK00psgsSy9x';

    function showStripeCardUI(clientSecret) {
        if (!stripe) {
            stripe = Stripe(STRIPE_PUBLISHABLE_KEY);
        }
        // Always re-initialize elements with the new clientSecret
        elements = stripe.elements({ clientSecret });
        // Pre-fill billing fields from form
        document.getElementById('billingName').value = (document.getElementById('firstName').value + ' ' + document.getElementById('lastName').value).trim();
        document.getElementById('billingEmail').value = document.getElementById('email').value.trim();
        // Express Checkout Element setup
        const expressDiv = document.getElementById('express-checkout-element');
        const expressErrors = document.getElementById('express-errors');
        expressDiv.innerHTML = '';
        expressErrors.textContent = '';
        // Unmount previous expressElement if exists
        if (window.expressElement && typeof window.expressElement.unmount === 'function') {
            window.expressElement.unmount();
        }
        window.expressElement = elements.create('expressCheckout');
        window.expressElement.mount('#express-checkout-element');
        window.expressElement.on('confirm', async (event) => {
            setPaymentStatus('Processing wallet payment...', false);
            const {error} = await stripe.confirmPayment({
                elements,
                clientSecret,
                confirmParams: {
                    return_url: window.location.href // Or a thank you page
                },
                redirect: 'if_required'
            });
            if (error) {
                expressErrors.textContent = error.message;
                setPaymentStatus('Wallet payment failed: ' + error.message, true);
            } else {
                setPaymentStatus('Wallet payment successful! Thank you for your order.', false);
                expressErrors.textContent = '';
                hideStripeCardUI();
            }
        });
        // Card Element setup: always re-create after elements is re-initialized
        if (window.cardElement && typeof window.cardElement.unmount === 'function') {
            window.cardElement.unmount();
        }
        window.cardElement = elements.create('card');
        window.cardElement.mount('#card-element');
        latestClientSecret = clientSecret;
        stripePaymentSection.style.display = 'block';
        cardErrorsDiv.textContent = '';
    }
    if (payNowButton) {
        payNowButton.addEventListener('click', async function(e) {
            e.preventDefault();
            payNowButton.disabled = true;
            cardErrorsDiv.textContent = '';
            setPaymentStatus('Processing payment...', false);
            if (!stripe || !cardElement || !latestClientSecret) {
                setPaymentStatus('Stripe is not initialized. Please try again.', true);
                payNowButton.disabled = false;
                return;
            }
            // Get billing details from new fields
            const name = document.getElementById('billingName').value.trim();
            const email = document.getElementById('billingEmail').value.trim();
            const {error, paymentIntent} = await stripe.confirmCardPayment(latestClientSecret, {
                payment_method: {
                    card: cardElement,
                    billing_details: { name, email }
                }
            });
            if (error) {
                cardErrorsDiv.textContent = error.message;
                setPaymentStatus('Payment failed: ' + error.message, true);
                payNowButton.disabled = false;
            } else if (paymentIntent && paymentIntent.status === 'succeeded') {
                setPaymentStatus('Payment successful! Thank you for your order.', false);
                cardErrorsDiv.textContent = '';
                payNowButton.disabled = true;
            } else {
                setPaymentStatus('Payment did not complete. Please try again.', true);
                payNowButton.disabled = false;
            }
        });
    }
    function hideStripeCardUI() {
        stripePaymentSection.style.display = 'none';
        cardErrorsDiv.textContent = '';
        expressErrorsDiv.textContent = '';
        if (window.cardElement && typeof window.cardElement.clear === 'function') window.cardElement.clear();
        if (window.cardElement && typeof window.cardElement.unmount === 'function') window.cardElement.unmount();
        if (window.expressElement && typeof window.expressElement.unmount === 'function') window.expressElement.unmount();
    }

    // --- Idempotency Key and CustomerId Persistence ---
    function getOrderSessionKey(orderDetails) {
        // Use a hash of the order details that define a unique order (e.g., email+quantity+shippingRate)
        // For simplicity, concatenate key fields
        return [
            orderDetails.email,
            orderDetails.quantity,
            orderDetails.shippingRate && orderDetails.shippingRate.id,
            orderDetails.address && orderDetails.address.line1,
            orderDetails.address && orderDetails.address.postal_code
        ].join('|');
    }

    function getPersistedOrderData(orderSessionKey) {
        if (window.localStorage) {
            const data = window.localStorage.getItem('orderData_' + orderSessionKey);
            if (data) return JSON.parse(data);
        }
        return null;
    }
    function persistOrderData(orderSessionKey, customerId, idempotencyKey) {
        if (window.localStorage) {
            window.localStorage.setItem('orderData_' + orderSessionKey, JSON.stringify({ customerId, idempotencyKey }));
        }
    }
    function clearPersistedOrderData(orderSessionKey) {
        if (window.localStorage) {
            window.localStorage.removeItem('orderData_' + orderSessionKey);
        }
    }

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        fetchShippingRates();
        return false;
    });
}); // End of DOMContentLoaded
    </script>
</body>
</html>
